{
  "provider": {
    "aws": [
      {
        "default_tags": {
          "tags": {
            "iac:stack-title": "My Ec2 Server",
            "iac:stack-name": "my-ec2-server"
          }
        }
      }
    ]
  },
  "terraform": {
    "required_providers": {
      "aws": {
        "source": "aws",
        "version": "6.28.0"
      }
    },
    "backend": {
      "s3": {
        "bucket": "my-ec2-server-backend",
        "key": "tfstates/app.tfstate",
        "region": "${provider,terraform.aws_provider.awsprovider_cloud.region}"
      }
    },
    "depends_on": [
      "provider,terraform.aws_provider"
    ]
  },
  "resource": {
    "aws_instance": {
      "awsinstance_myec2server": {
        "ami": "${data.aws_ami.awsami_ami.id}",
        "associate_public_ip_address": true,
        "iam_instance_profile": "my-ec2-server-instance-profile",
        "instance_type": "t4g.nano",
        "root_block_device": {
          "volume_size": 8
        },
        "subnet_id": "${aws_subnet.awssubnet_myec2serverpublicasubnet.id}",
        "depends_on": [
          "aws_subnet.awssubnet_myec2serverpublicasubnet"
        ],
        "tags": {
          "Name": "my-ec2-server",
          "iac:id": "awsinstance_myec2server"
        }
      }
    },
    "aws_vpc": {
      "awsvpc_myec2servervpc": {
        "cidr_block": "10.10.0.0/16",
        "tags": {
          "Name": "my-ec2-server-vpc",
          "iac:id": "awsvpc_myec2servervpc"
        }
      }
    },
    "aws_subnet": {
      "awssubnet_myec2serverpublicasubnet": {
        "vpc_id": "${aws_vpc.awsvpc_myec2servervpc.id}",
        "availability_zone": "${provider,terraform.aws_provider.awsprovider_cloud.region}a",
        "cidr_block": "10.10.200.0/24",
        "depends_on": [
          "aws_vpc.awsvpc_myec2servervpc",
          "provider,terraform.aws_provider"
        ],
        "tags": {
          "Name": "my-ec2-server-public-a-subnet",
          "iac:id": "awssubnet_myec2serverpublicasubnet"
        }
      }
    },
    "aws_internet_gateway": {
      "awsinternetgateway_myec2serverinternetgateway": {
        "vpc_id": "${aws_vpc.awsvpc_myec2servervpc.id}",
        "depends_on": [
          "aws_vpc.awsvpc_myec2servervpc"
        ],
        "tags": {
          "Name": "my-ec2-server-internet-gateway",
          "iac:id": "awsinternetgateway_myec2serverinternetgateway"
        }
      }
    },
    "aws_default_route_table": {
      "awsdefaultroutetable_myec2serverdefaultroutetable": {
        "default_route_table_id": "${aws_vpc.awsvpc_myec2servervpc.default_route_table_id}",
        "depends_on": [
          "aws_vpc.awsvpc_myec2servervpc"
        ],
        "tags": {
          "Name": "my-ec2-server-default-route-table",
          "iac:id": "awsdefaultroutetable_myec2serverdefaultroutetable"
        }
      }
    },
    "aws_route": {
      "awsroute_route": {
        "route_table_id": "${aws_vpc.awsvpc_myec2servervpc.default_route_table_id}",
        "destination_cidr_block": "0.0.0.0/0",
        "gateway_id": "${aws_internet_gateway.awsinternetgateway_myec2serverinternetgateway.id}",
        "depends_on": [
          "aws_vpc.awsvpc_myec2servervpc",
          "aws_internet_gateway.awsinternetgateway_myec2serverinternetgateway"
        ]
      }
    },
    "aws_iam_role": {
      "awsiamrole_myec2serverinstancerole": {
        "assume_role_policy": "{\"Version\":\"2012-10-17\",\"Statement\":[{\"Effect\":\"Allow\",\"Principal\":{\"Service\":\"ec2.amazonaws.com\"},\"Action\":\"sts:AssumeRole\"}]}",
        "name": "my-ec2-server-instance-role",
        "tags": {
          "Name": "my-ec2-server-instance-role",
          "iac:id": "awsiamrole_myec2serverinstancerole"
        }
      }
    },
    "aws_iam_instance_profile": {
      "awsiaminstanceprofile_myec2serverinstanceprofile": {
        "name": "my-ec2-server-instance-profile",
        "role": "my-ec2-server-instance-role",
        "tags": {
          "Name": "my-ec2-server-instance-profile",
          "iac:id": "awsiaminstanceprofile_myec2serverinstanceprofile"
        }
      }
    },
    "aws_iam_role_policy_attachment": {
      "awsiamrolepolicyattachment_iamrolepolicyattachment": {
        "depends_on": [
          "aws_iam_role.awsiamrole_myec2serverinstancerole"
        ],
        "policy_arn": "arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore",
        "role": "my-ec2-server-instance-role"
      }
    },
    "aws_s3_bucket": {
      "awss3bucket_backend": {
        "bucket": "my-ec2-server-backend",
        "object_lock_enabled": true,
        "tags": {
          "Name": "Backend Bucket",
          "iac:id": "awss3bucket_backend"
        }
      }
    },
    "aws_s3_bucket_versioning": {
      "awss3bucket_backend_versioning": {
        "depends_on": [
          "aws_s3_bucket.awss3bucket_backend"
        ],
        "bucket": "my-ec2-server-backend",
        "versioning_configuration": {
          "status": "Enabled"
        }
      }
    }
  },
  "output": {
    "output_myec2serverpublicip": {
      "value": "${aws_instance.awsinstance_myec2server.public_ip}",
      "description": "Public IP of my-ec2-server",
      "depends_on": [
        "aws_instance.awsinstance_myec2server"
      ]
    },
    "output_myec2serverinstanceid": {
      "value": "${aws_instance.awsinstance_myec2server.id}",
      "description": "Instance ID of my-ec2-server",
      "depends_on": [
        "aws_instance.awsinstance_myec2server"
      ]
    }
  },
  "data": {
    "aws_ami": {
      "awsami_ami": {
        "filter": [
          {
            "name": "architecture",
            "values": [
              "arm64"
            ]
          }
        ],
        "most_recent": true,
        "name_regex": "^al\\d{4}-ami-\\d{4}.*",
        "owners": [
          "amazon"
        ]
      }
    }
  }
}
